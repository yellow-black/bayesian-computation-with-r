<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="s-takano" />


<title>chapter4</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">chapter4</h1>
<h4 class="author">s-takano</h4>

</div>


<pre class="r"><code>set.seed(29)</code></pre>
<pre class="r"><code>library(LearnBayes)</code></pre>
<div id="section" class="section level2">
<h2>4-1</h2>
<p><span class="math display">\[
y_1, y_2, \ldots, y_{20} \sim \mathcal{N}(\mu, \sigma^2)
\]</span></p>
<p>データとしては、以下が与えられている．</p>
<pre class="r"><code>y = c(9.0, 8.5, 7.0, 8.5, 6.0, 12.5, 6.0, 9.0, 8.5, 7.5, 8.0, 6.0, 9.0, 8.0, 7.0, 10.0, 9.0, 7.5, 5.0, 6.5)
y</code></pre>
<pre><code>##  [1]  9.0  8.5  7.0  8.5  6.0 12.5  6.0  9.0  8.5  7.5  8.0  6.0  9.0  8.0  7.0 10.0  9.0  7.5  5.0  6.5</code></pre>
<pre class="r"><code>length(y)</code></pre>
<pre><code>## [1] 20</code></pre>
<p>無情報事前分布として、<span class="math inline">\(g(\mu, \sigma^2) \propto \frac{1}{\sigma^2}\)</span> とすると、</p>
<p><span class="math display">\[
\begin{aligned}
  g(\mu, \sigma^2|y) 
  &amp;\propto \frac{1}{\sigma^2} \prod_{i = 1}^n \mathcal{N}(\mu, \sigma^2) \\
  &amp;= \frac{1}{\sigma^2} \prod_{i = 1}^n \frac{1}{\sqrt{2\pi}\sigma} \exp \left( - \frac{1}{2\sigma^2} (y_i - \mu)^2 \right) \\  
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( \sum_{i = 1}^n - \frac{1}{2\sigma^2} (y_i - \mu)^2 \right) \\  
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i + \bar{y} - \bar{y} - \mu)^2 \right) \\ 
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n \left( (y_i - \bar{y})^2 +2(y_i - \bar{y})(\bar{y} - \mu) + (\bar{y} - \mu)^2 \right) \right) \\ 
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n \left( (y_i - \bar{y})^2  \right) + 2n(\bar{y} - \bar{y})(\bar{y} - \mu) + n(\bar{y} - \mu)^2 \right) \\ 
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} (\sum_{i = 1}^n (y_i - \bar{y})^2 + n(\mu - \bar{y})^2) \right) 
\end{aligned}
\]</span></p>
<p>となる． ここで、</p>
<p><span class="math display">\[
\begin{aligned}
  g(\mu|y, \sigma^2)
  &amp;= \frac{g(\mu, \sigma^2|y)}{g(\sigma^2|y)} \\
  &amp;\propto g(\mu, \sigma^2|y) \\
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} (\sum_{i = 1}^n (y_i - \bar{y})^2 + n(\mu - \bar{y})^2) \right) \\
  &amp;\propto \exp \left( - \frac{1}{2\sigma^2} (\sum_{i = 1}^n (y_i - \bar{y})^2 + n(\mu - \bar{y})^2) \right) \\
  &amp;\propto \exp \left( - \frac{1}{2\sigma^2} n(\mu - \bar{y})^2 \right) \\
  &amp;\propto \exp \left( - \frac{1}{2(\frac{\sigma}{\sqrt{n}})^2} (\mu - \bar{y})^2 \right) \\
\end{aligned}
\]</span></p>
<p>である． よって、</p>
<p><span class="math display">\[
g(\mu|y, \sigma^2) = \mathcal{N}(\bar{y}, (\frac{\sigma}{\sqrt{n}})^2)
\]</span></p>
<p>また、</p>
<p><span class="math display">\[
\begin{aligned}
  g(\sigma^2|y)  
  &amp;= \int g(\mu, \sigma^2|y) d\mu \\
  &amp;= \int \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} (\sum_{i = 1}^n (y_i - \bar{y})^2 + n(\mu - \bar{y})^2) \right) d\mu \\
  &amp;= \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \int \exp \left( - \frac{1}{2\sigma^2} (\sum_{i = 1}^n (y_i - \bar{y})^2 + n(\mu - \bar{y})^2) \right) d\mu \\
  &amp;= \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \int \exp \left( - \frac{1}{2\sigma^2} n(\mu - \bar{y})^2 \right) d\mu \\
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \int \exp \left( - \frac{1}{2(\frac{\sigma}{\sqrt{n}})^2} (\mu - \bar{y})^2 \right) d\mu \\
\end{aligned}
\]</span></p>
<p>ここで、</p>
<p><span class="math display">\[
\int \exp \left( - \frac{1}{2(\frac{\sigma}{\sqrt{n}})^2} (\mu - \bar{y})^2 \right) d\mu
\]</span></p>
<p>は、<span class="math inline">\(\mathcal{N}(\bar{y}, (\frac{\sigma}{\sqrt{n}})^2)\)</span> の正規化項に相当するので、</p>
<p><span class="math display">\[
\int \exp \left( - \frac{1}{2(\frac{\sigma}{\sqrt{n}})^2} (\mu - \bar{y})^2 \right) d\mu = \sqrt{2\pi(\frac{\sigma}{\sqrt{n}})^2} = \sqrt{\frac{2\pi\sigma^2}{n}}
\]</span></p>
<p>である．</p>
<p><span class="math display">\[
\begin{aligned}
  g(\sigma^2|y)  
  &amp;\propto \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \int \exp \left( - \frac{1}{2(\frac{\sigma}{\sqrt{n}})^2} (\mu - \bar{y})^2 \right) d\mu \\
  &amp;= \frac{1}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \sqrt{\frac{2\pi\sigma^2}{n}} \\
  &amp;\propto \frac{\sigma}{(\sigma^2)^{\frac{n}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \\
  &amp;= \frac{1}{(\sigma^2)^{\frac{n}{2}+1-\frac{1}{2}}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \\
  &amp;= \frac{1}{(\sigma^2)^{\frac{n-1}{2}+1}} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \\
  &amp;= (\sigma^2)^{-\frac{n-1}{2}-1} \exp \left( - \frac{1}{2\sigma^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) \\
  &amp;= (\sigma^2)^{-\frac{n-1}{2}-1} \exp \left( - \frac{1}{2\sigma^2} S \right) \\
  &amp;= (\sigma^2)^{-\frac{n-1}{2}-1} \exp \left( - \frac{1}{2}\frac{1}{\frac{\sigma^2}{S}} \right) \\
  &amp;\propto (\frac{\sigma^2}{S})^{-\frac{n-1}{2}-1} \exp \left( - \frac{1}{2}\frac{1}{\frac{\sigma^2}{S}} \right) \\
\end{aligned}
\]</span></p>
<p>よって、<span class="math inline">\(\frac{\sigma^2}{S}\)</span> は <a href="https://mc-stan.org/docs/2_23/functions-reference/inverse-chi-square-distribution.html">逆カイ二乗分布</a> に従う．</p>
<p><span class="math display">\[
\frac{\sigma^2}{S} \sim InvChiSquare(n-1)
\]</span></p>
<div id="a" class="section level3">
<h3>(a)</h3>
<p><span class="math display">\[
g_{\mu,\sigma^2}(\mu, \sigma^2|y) = g_{\mu|\sigma^2}(\mu|\sigma^2, y)g_{\sigma^2}(\sigma^2|y)
\]</span></p>
<p>であるので、以下のようなアルゴリズムでサンプリングが可能である．</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\sigma^2}{S} &amp;\sim InvChiSquare(n-1) \\
  \mu &amp;\sim \mathcal{N}(\bar{y}, (\frac{\sigma}{\sqrt{n}})^2) \\ 
\end{aligned}
\]</span></p>
<p>ここで、<span class="math inline">\(S = \sum_{i = 1}^n (y_i - \bar{y})^2\)</span> である．</p>
<pre class="r"><code>S = sum((y - mean(y))^2)
n = length(y)
sigma2 = S * 1/rchisq(1000, n - 1)
mu = rnorm(1000, mean = mean(y), sd = sqrt(sigma2)/sqrt(n))
plot(mu, sigma2)</code></pre>
<p><img src="chapter4_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="b" class="section level3">
<h3>(b)</h3>
<pre class="r"><code>quantile(mu, c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 7.209646 8.615881</code></pre>
<pre class="r"><code>quantile(sqrt(sigma2), c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 1.344823 2.405518</code></pre>
</div>
<div id="c" class="section level3">
<h3>(c)</h3>
<pre class="r"><code>p_75 = mu + 0.674 * sqrt(sigma2)
mean(p_75)</code></pre>
<pre><code>## [1] 9.116239</code></pre>
<pre class="r"><code>sd(p_75)</code></pre>
<pre><code>## [1] 0.4742668</code></pre>
</div>
</div>
<div id="section-1" class="section level2">
<h2>4-2</h2>
<p>独立した標本が2つあり、それぞれ以下のようになっている．</p>
<p><span class="math display">\[
\begin{aligned}
  x_1, x_2, \ldots, x_m &amp;\sim \mathcal{N}(\mu_1,\sigma_1^2) \\
  y_1, y_2, \ldots, y_n &amp;\sim \mathcal{N}(\mu_2,\sigma_2^2) \\
\end{aligned}
\]</span></p>
<p>事前分布を以下とする．</p>
<p><span class="math display">\[
g(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2) \propto \frac{1}{\sigma_1^2\sigma_2^2}
\]</span></p>
<div id="a-1" class="section level3">
<h3>(a)</h3>
<p>事後密度は以下のように計算できる<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>．</p>
<p><span class="math display">\[
\begin{aligned}
  g(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2|x,y) 
  &amp;= \frac{g(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2, x, y)}{g(x, y)} \\
  &amp;= \frac{g(x, y|\mu_1, \sigma_1^2, \mu_2, \sigma_2^2)g(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2)}{g(x, y)} \\
  &amp;\propto \frac{g(x, y|\mu_1, \sigma_1^2, \mu_2, \sigma_2^2)}{g(x, y)}\frac{1}{\sigma_1^2\sigma_2^2} \\
  &amp;\propto g(x|\mu_1, \sigma_1^2, \mu_2, \sigma_2^2) \frac{1}{\sigma_1^2\sigma_2^2} \\
  &amp;= g(x|\mu_1, \sigma_1^2)g(y|\mu_2, \sigma_2^2) \frac{1}{\sigma_1^2\sigma_2^2} \\
  &amp;= 
  \prod_{i = 1}^m \mathcal{N}(\mu_1, \sigma_1^2) 
  \prod_{i = 1}^n \mathcal{N}(\mu_2, \sigma_2^2)
  \frac{1}{\sigma_1^2\sigma_2^2} \\
  &amp;= 
  \prod_{i = 1}^m \frac{1}{\sqrt{2\pi}\sigma_1} \exp \left( - \frac{1}{2\sigma_1^2} (x_i - \mu_1)^2 \right) 
  \prod_{i = 1}^n \frac{1}{\sqrt{2\pi}\sigma_2} \exp \left( - \frac{1}{2\sigma_2^2} (y_i - \mu_2)^2 \right) 
  \frac{1}{\sigma_1^2\sigma_2^2} \\
  &amp;\propto
  \frac{1}{\sigma_1^m} \exp \left( - \frac{1}{2\sigma_1^2} \sum_{i = 1}^m (x_i - \mu_1)^2 \right) 
  \frac{1}{\sigma_2^n} \exp \left( - \frac{1}{2\sigma_2^2} \sum_{i = 1}^n (y_i - \mu_2)^2 \right) 
  \frac{1}{\sigma_1^2\sigma_2^2} \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} \sum_{i = 1}^m (x_i - \mu_1)^2 \right) 
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} \sum_{i = 1}^n (y_i - \mu_2)^2 \right) \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} \sum_{i = 1}^m (x_i - \bar{x})^2 + m(\mu_1 - \bar{x})^2 \right) 
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} \sum_{i = 1}^n (y_i - \bar{y})^2 + n(\mu_2 - \bar{y})^2 \right) \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} \sum_{i = 1}^m (x_i - \bar{x})^2 \right) 
  \exp \left( - \frac{1}{2\sigma_1^2} m(\mu_1 - \bar{x})^2 \right) \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} \sum_{i = 1}^n (y_i - \bar{y})^2 \right) 
  \exp \left( - \frac{1}{2\sigma_2^2} n(\mu_2 - \bar{y})^2 \right) \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) 
  \exp \left( - \frac{1}{2\sigma_1^2} m(\mu_1 - \bar{x})^2 \right) \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) 
  \exp \left( - \frac{1}{2\sigma_2^2} n(\mu_2 - \bar{y})^2 \right) \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) 
  \exp \left( - \frac{1}{2(\frac{\sigma_1}{\sqrt{m}})^2} (\mu_1 - \bar{x})^2 \right) \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) 
  \exp \left( - \frac{1}{2(\frac{\sigma_1}{\sqrt{n}})^2} (\mu_2 - \bar{y})^2 \right) \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) 
  \mathcal{N}(\bar{x}, (\frac{\sigma_1}{\sqrt{m}})^2)
  \int \exp \left( - \frac{1}{2(\frac{\sigma_1}{\sqrt{m}})^2} (\mu_1 - \bar{x})^2 \right) d\mu_1 \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) 
  \mathcal{N}(\bar{y}, (\frac{\sigma_2}{\sqrt{n}})^2)
  \int \exp \left( - \frac{1}{2(\frac{\sigma_2}{\sqrt{n}})^2} (\mu_2 - \bar{y})^2 \right) d\mu_2 \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) 
  \mathcal{N}(\bar{x}, (\frac{\sigma_1}{\sqrt{m}})^2)
  \sqrt{\frac{2\pi\sigma_1^2}{m}} \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) 
  \mathcal{N}(\bar{y}, (\frac{\sigma_2}{\sqrt{n}})^2)
  \sqrt{\frac{2\pi\sigma_2^2}{n}} \\
  &amp;\propto
  \frac{1}{(\sigma_1^2)^{\frac{m}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) 
  \mathcal{N}(\bar{x}, (\frac{\sigma_1}{\sqrt{m}})^2)
  \sigma_1 \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) 
  \mathcal{N}(\bar{y}, (\frac{\sigma_2}{\sqrt{n}})^2)
  \sigma_2 \\
  &amp;=
  \frac{1}{(\sigma_1^2)^{\frac{m - 1}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) 
  \mathcal{N}(\bar{x}, (\frac{\sigma_1}{\sqrt{m}})^2) \\
  &amp;\times
  \frac{1}{(\sigma_2^2)^{\frac{n - 1}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) 
  \mathcal{N}(\bar{y}, (\frac{\sigma_2}{\sqrt{n}})^2) \\
\end{aligned}
\]</span></p>
<p>このとき、</p>
<p><span class="math display">\[
\begin{aligned}
  g(\mu_1, \sigma_1^2|x) 
  &amp;= \frac{1}{(\sigma_1^2)^{\frac{m - 1}{2} + 1}} \exp \left( - \frac{1}{2\sigma_1^2} S_1 \right) \mathcal{N}(\bar{x}, (\frac{\sigma_1}{\sqrt{m}})^2) \\
  g(\mu_2, \sigma_2^2|y) 
  &amp;= \frac{1}{(\sigma_2^2)^{\frac{n - 1}{2} + 1}} \exp \left( - \frac{1}{2\sigma_2^2} S_2 \right) \mathcal{N}(\bar{y}, (\frac{\sigma_2}{\sqrt{n}})^2) \\
\end{aligned}
\]</span></p>
<p>としたとき、</p>
<p><span class="math display">\[
g(\mu_1, \sigma_1^2, \mu_2, \sigma_2^2|x,y) \propto g(\mu_1, \sigma_1^2|x) g(\mu_2, \sigma_2^2|y) 
\]</span></p>
<p>となり、互いに独立した事後分布に従う．</p>
</div>
<div id="b-1" class="section level3">
<h3>(b)</h3>
<p>互いに独立しているので、それぞれの分布からサンプリングすれば良く、次のようになる<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>．</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\sigma_1^2}{S_1} &amp;\sim InvChiSquare(m-1) \\
  \mu_1 &amp;\sim \mathcal{N}(\bar{x}, (\frac{\sigma_1}{\sqrt{m}})^2) \\ 
  \frac{\sigma_2^2}{S_2} &amp;\sim InvChiSquare(n-1) \\
  \mu_2 &amp;\sim \mathcal{N}(\bar{y}, (\frac{\sigma_2}{\sqrt{m}})^2) \\ 
\end{aligned}
\]</span></p>
</div>
<div id="c-1" class="section level3">
<h3>(c)</h3>
<pre class="r"><code>sample_size = 10000
x = c(120, 107, 110, 116, 114, 111, 113, 117, 114, 112)
S_1 = sum((x - mean(x))^2)
m = length(x)
sigma2_1 = S_1 * 1/rchisq(sample_size, m - 1)
mu_1 = rnorm(sample_size, mean = mean(x), sd = sqrt(sigma2_1)/sqrt(m))
quantile(mu_1, c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 111.2274 115.5527</code></pre>
<pre class="r"><code>quantile(sqrt(sigma2_1), c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 2.720200 6.059221</code></pre>
<pre class="r"><code>y = c(110, 111, 107, 108, 110, 105, 107, 106, 111, 111)
S_2 = sum((y - mean(y))^2)
n = length(y)
sigma2_2 = S_2 * 1/rchisq(sample_size, n - 1)
mu_2 = rnorm(sample_size, mean = mean(y), sd = sqrt(sigma2_2)/sqrt(n))
quantile(mu_2, c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 107.2773 109.9402</code></pre>
<pre class="r"><code>quantile(sqrt(sigma2_2), c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 1.652193 3.732908</code></pre>
<pre class="r"><code>hist(mu_1 - mu_2)</code></pre>
<p><img src="chapter4_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<div id="section-2" class="section level2">
<h2>4-3</h2>
<p><span class="math display">\[
\begin{aligned}
  n_N &amp;= 1601 + 162527 \\
  y_N &amp;= 1601 \\
  n_S &amp;= 510 + 412368 \\
  y_S &amp;= 510 \\
  y_N &amp;\perp y_S \\
  y_N &amp;\sim Bin(n_N, p_N) \\ 
  y_S &amp;\sim Bin(n_S, p_S) \\ 
  p_N, p_S &amp;\sim Uniform(-\infty, \infty) \\
\end{aligned}
\]</span></p>
<div id="a-2" class="section level3">
<h3>(a)</h3>
<p><span class="math display">\[
\begin{aligned}
  p(p_N, p_S|y_N, y_S) 
  &amp;= \frac{p(y_N, y_S|p_N, p_S)p(p_N, p_S)}{p(y_N, y_S)} \\
  &amp;= \frac{p(y_N, y_S|p_N, p_S) \cdot 1}{p(y_N, y_S)} \\
  &amp;\propto p(y_N, y_S|p_N, p_S) \\
  &amp;= p(y_N|p_N)p(y_S|p_S) \\
  &amp;\propto p(y_N|p_N)p(y_S|p_S) \\
  &amp;\propto p_N^{y_N}(1 - p_N)^{n_N-y_N} p_S^{y_S}(1 - p_S)^{n_S-y_S} \\
  &amp;\propto Beta(p_N|y_N+1, n_N-y_N+1)Beta(p_S|y_S+1, n_S-y_S+1)
\end{aligned}
\]</span></p>
<p>よって、</p>
<p><span class="math display">\[
\begin{aligned}
  p_N &amp;\sim Beta(p_N|y_N+1, n_N-y_N+1) \\
  p_S &amp;\sim Beta(p_S|y_S+1, n_S-y_S+1)
\end{aligned}
\]</span></p>
</div>
<div id="b-2" class="section level3">
<h3>(b)</h3>
<pre class="r"><code>n_N = 1601 + 162527
y_N = 1601
n_S = 510 + 412368
y_S = 510
sample_size = 10000
p_N = rbeta(sample_size, y_N + 1, n_N - y_N + 1)
p_S = rbeta(sample_size, y_S + 1, n_S - y_S + 1)</code></pre>
</div>
<div id="c-2" class="section level3">
<h3>(c)</h3>
<pre class="r"><code>hist(p_N/p_S)</code></pre>
<p><img src="chapter4_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>quantile(p_N/p_S, c(0.025, 0.975))</code></pre>
<pre><code>##     2.5%    97.5% 
## 7.142733 8.736755</code></pre>
</div>
<div id="d" class="section level3">
<h3>(d)</h3>
<pre class="r"><code>hist(p_N - p_S)</code></pre>
<p><img src="chapter4_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="e" class="section level3">
<h3>(e)</h3>
<pre class="r"><code>sum((p_N - p_S) &gt; 0) / sample_size</code></pre>
<pre><code>## [1] 1</code></pre>
</div>
</div>
<div id="section-3" class="section level2">
<h2>4-4</h2>
<div id="a-3" class="section level3">
<h3>(a)</h3>
<p>4-1 と同様な計算により、</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\sigma^2}{S} &amp;\sim InvChiSquare(n-1) \\
  \mu &amp;\sim \mathcal{N}(\bar{y}, (\frac{\sigma}{\sqrt{n}})^2) \\ 
\end{aligned}
\]</span></p>
<pre class="r"><code>sample_size = 1000
y = c(10, 11, 12, 11, 9)
S = sum((y - mean(y))^2)
n = length(y)
sigma2 = S * 1 / rchisq(sample_size, n - 1)
mu = rnorm(sample_size, mean = mean(y), sd = sqrt(sigma2)/sqrt(n))
length(mu)</code></pre>
<pre><code>## [1] 1000</code></pre>
<pre class="r"><code>length(sigma2)</code></pre>
<pre><code>## [1] 1000</code></pre>
<pre class="r"><code>mean(mu)</code></pre>
<pre><code>## [1] 10.5626</code></pre>
<pre class="r"><code>mean(sigma2)</code></pre>
<pre><code>## [1] 2.619525</code></pre>
</div>
<div id="b-3" class="section level3">
<h3>(b)</h3>
<p>丸められる前の観測値を <span class="math inline">\(z_n\)</span> とする．</p>
<p><span class="math display">\[
z_1, z_2, \ldots, z_{5} \sim \mathcal{N}(\mu, \sigma^2)
\]</span></p>
<p>このとき、丸められた測定値は以下のように表せる．</p>
<p><span class="math display">\[
y_n \in (z_n - \frac{1}{2}, z_n + \frac{1}{2})
\]</span></p>
<p>このとき、<span class="math inline">\(y\)</span> の確率質量関数は、丸められる前の観測値 <span class="math inline">\(z_n\)</span> を周辺化することで以下のように表せる．</p>
<p><span class="math display">\[
\begin{aligned}
  p(y_n|\mu, \sigma^2) 
  &amp;= \int_{y_n-\frac{1}{2}}^{y_n+\frac{1}{2}} \mathcal{N}(z_n|\mu, \sigma^2) dz_n \\
  &amp;= \Phi(\frac{y_n+\frac{1}{2} - \mu}{\sigma}) - \Phi(\frac{y_n-\frac{1}{2} - \mu}{\sigma})
\end{aligned}
\]</span></p>
<p>ここで、<span class="math inline">\(\Phi\)</span> は標準正規分布の累積確率分布である． 無情報事前分布として、</p>
<p><span class="math display">\[
p(\mu, \sigma^2) \propto \frac{1}{\sigma^2}
\]</span></p>
<p>とする． よって、事後分布は次のように表せる<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>．</p>
<p><span class="math display">\[
\begin{aligned}
  p(\mu, \sigma^2|y) 
  &amp;\propto p(\mathbb{y}|\mu, \sigma^2) p(\mu, \sigma^2) \\
  &amp;\propto \prod_{n=1}^{N} p(y_n|\mu, \sigma^2) \frac{1}{\sigma^2} \\
  &amp;= \frac{1}{\sigma^2} \prod_{n=1}^{N} \left( \Phi(\frac{y_n+\frac{1}{2} - \mu}{\sigma}) - \Phi(\frac{y_n-\frac{1}{2} - \mu}{\sigma}) \right)
\end{aligned}
\]</span></p>
</div>
<div id="c-3" class="section level3">
<h3>(c)</h3>
<p>まず、対数をとった事後分布を導出する．</p>
<p><span class="math display">\[
\begin{aligned}
  \ln p(\mu, \sigma^2|y)
  &amp;= \ln \frac{1}{\sigma^2} \prod_{n=1}^{N} \left( \Phi(\frac{y_n+\frac{1}{2} - \mu}{\sigma}) - \Phi(\frac{y_n-\frac{1}{2} - \mu}{\sigma}) \right) \\
  &amp;= \sum_{n=1}^{N} \ln \left( \Phi(\frac{y_n+\frac{1}{2} - \mu}{\sigma}) - \Phi(\frac{y_n-\frac{1}{2} - \mu}{\sigma}) \right) - \ln \sigma^2
\end{aligned}
\]</span></p>
<pre class="r"><code>y</code></pre>
<pre><code>## [1] 10 11 12 11  9</code></pre>
<p>上記の結果から、以下のようなグリッドを用意する<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>．</p>
<pre class="r"><code>N = length(y)

p = function (mu, sigma2, y) {
  return(
    sum(
      log(
        pnorm((y + 1/2 - mu) / sqrt(sigma2)) - pnorm((y - 1/2 - mu) / sqrt(sigma2))
      )
    ) 
    - 
    log(sigma2)
  )
}

ng = 50 # num of grids
mu = seq(5, 20, len = ng)
dmu = diff(mu[1:2])
sigma2 = seq(0.1, 5, len = ng)
dsigma2 = diff(sigma2[1:2])

probs = matrix(nrow = ng, ncol = ng)
for (i in 1:ng) {
  for (j in 1:ng) {
    probs[i, j] = p(mu[i], sigma2[j], y)
  }
}
probs = probs - max(probs)
probs = exp(probs)
probs = probs / sum(probs)
marginal_prob = rowSums(probs) # p(mu|y)

sample_size = 1000
mu_sample = c()
sigma2_sample = c()
for (n in 1:sample_size) {
  i = sample(1:ng, 1, replace=TRUE, prob = marginal_prob)
  mu_sample = c(mu_sample, mu[i] + runif(1) * dmu - dmu / 2) 
  j = sample(1:ng, 1, replace=TRUE, prob = probs[i,]) # p(sigma^2|mu, y)
  sigma2_sample = c(sigma2_sample, sigma2[j] + runif(1) * dsigma2 - dsigma2 / 2)
}
mean(mu_sample)</code></pre>
<pre><code>## [1] 10.59278</code></pre>
<pre class="r"><code>mean(sigma2_sample)</code></pre>
<pre><code>## [1] 1.621955</code></pre>
<p>LearnBayes を用いてみる．</p>
<pre class="r"><code>p = function (theta, data) {
  mu = theta[1]
  sigma2 = theta[2]
  return(
    sum(
      log(
        pnorm((data + 1/2 - mu) / sqrt(sigma2)) - pnorm((y - 1/2 - mu) / sqrt(sigma2))
      )
    ) 
    - 
    log(sigma2)
  )
}
s = simcontour(p, c(5, 20, 0.1, 5), y, 1000)
mean(s$x)</code></pre>
<pre><code>## [1] 10.59801</code></pre>
<pre class="r"><code>mean(s$y)</code></pre>
<pre><code>## [1] 1.648196</code></pre>
<p>Stan を用いてみる．</p>
<pre class="r"><code>sample = extract(fit)
mean(sample$mu)</code></pre>
<pre><code>## [1] 10.5802</code></pre>
<pre class="r"><code>mean(sample$sigma)</code></pre>
<pre><code>## [1] 1.362632</code></pre>
</div>
<div id="d-1" class="section level3">
<h3>(d)</h3>
<ol style="list-style-type: lower-alpha">
<li>の結果は以下のようになる．</li>
</ol>
<pre><code>[1] 10.61258
[1] 2.818481</code></pre>
<ol start="3" style="list-style-type: lower-alpha">
<li>の結果は以下のようになる．</li>
</ol>
<pre><code>[1] 10.58333
[1] 1.615329</code></pre>
</div>
</div>
<div id="section-4" class="section level2">
<h2>4-5</h2>
<p><span class="math display">\[
y_1, \ldots, y_n \sim f(y|a,b) 
\]</span></p>
<p><span class="math display">\[
f(y|a,b) = \frac{\Gamma(y + a)}{\Gamma(a)y!}\frac{b^a}{(b + 1)^{y+a}} \quad (a, b &gt; 0)
\]</span></p>
<p>上記の式の導出を試みる． まず、ポアソン分布は以下のようにかける．</p>
<p><span class="math display">\[
Po(y|\lambda) \sim \frac{1}{y!} \lambda^y \exp(-\lambda)
\]</span></p>
<p>次に、ガンマ分布は以下のようにかける．</p>
<p><span class="math display">\[
Gamma(y|a, b) = \frac{b^a}{\Gamma(a)} y^{a-1} \exp(-by)
\]</span></p>
<p>よって、ポアソン・ガンマの混合は次のようにかける．</p>
<p><span class="math display">\[
\begin{aligned}
  \lambda &amp;\sim Gamma(\lambda|a,b) \\
  y &amp;\sim Po(y|\lambda) 
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
  p(y|a,b) 
  &amp;= \int Po(y|\lambda) Gamma(\lambda|a,b) \; d\lambda \\
  &amp;= \int \frac{1}{y!} \lambda^y \exp(-\lambda) \frac{b^a}{\Gamma(a)} \lambda^{a-1} \exp(-b\lambda) \; d\lambda \\
  &amp;= \frac{1}{y!} \frac{b^a}{\Gamma(a)} \int \lambda^y  \exp(-\lambda) \lambda^{a-1} \exp(-b\lambda) \; d\lambda \\
  &amp;= \frac{1}{y!} \frac{b^a}{\Gamma(a)} \int \lambda^{y + a - 1} \exp(-(b+1)\lambda) \; d\lambda \\
  &amp;= \frac{1}{y!} \frac{b^a}{\Gamma(a)} \frac{\Gamma(y + a)}{(b + 1)^{(y + a)}} \\
  &amp;= \frac{\Gamma(y + a)}{\Gamma(a)y!}\frac{b^a}{(b + 1)^{y+a}}
\end{aligned}
\]</span></p>
<p>事前分布を以下とすると、</p>
<p><span class="math display">\[
p(a,b) \propto \frac{1}{(ab)^2}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
  p(\theta_1, \theta_2|data) 
  &amp;\propto \frac{1}{ab} \prod_{i=1}^n \frac{\Gamma(y_i + a)}{\Gamma(a) y_i!}\frac{b^a}{(b + 1)^{y_i+a}} \\
  a &amp;= \exp(\theta_1), \\
  b &amp;= \exp(\theta_2)
\end{aligned}
\]</span></p>
<pre class="r"><code>y = c(2, 5, 0, 2, 3, 1, 3, 4, 3, 0, 3, 
      2, 1, 1, 0, 6, 0, 0, 3, 0, 1, 1,
      5, 0, 1, 2, 0, 0, 2, 1, 1, 1, 0)

n = length(y)</code></pre>
<p>グリッド範囲を決定するため、最尤推定を行う．</p>
<p><span class="math display">\[
\begin{aligned}
  L(a, b) 
  &amp;= \sum_{i=1}^n \log \frac{\Gamma(y_i + a)}{\Gamma(a) y_i!}\frac{b^a}{(b + 1)^{y_i + a}} \\
  &amp;= \sum_{i=1}^n \log \Gamma(y_i + a) - \log \Gamma(a) - \log y_i! + a \log b - (y_i + a)\log (b + 1) \\
\end{aligned}
\]</span></p>
<p>よって、</p>
<p><span class="math display">\[
\begin{aligned}
  \underset{a,b}{\operatorname{argmax}} {L(a,b)} 
  &amp;= \underset{a,b}{\operatorname{argmax}} {\sum_{i=1}^n \log \Gamma(y_i + a) - \log \Gamma(a) - \log y_i! + a \log b - (y_i + a)\log (b + 1)} \\
  &amp;= \underset{a,b}{\operatorname{argmax}} {\sum_{i=1}^n \log \Gamma(y_i + a) - \log \Gamma(a) + a \log b - (y_i + a)\log (b + 1)} \\
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\partial L}{\partial a} 
  &amp;= \frac{\partial}{\partial a} \sum_{i=1}^n \log \Gamma(y_i + a) - \log \Gamma(a) - \log y_i! + a \log b - (y_i + a)\log (b + 1) \\
  &amp;= \sum_{i=1}^n \psi(y_i + a) - \psi(a) + \log b - \log (b + 1) \\
\end{aligned}
\]</span></p>
<p>ここで、<span class="math inline">\(\psi\)</span> はディガンマ関数である．ディガンマ関数の性質<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>より、</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\partial L}{\partial a} 
  &amp;= \sum_{i=1}^n \psi(y_i + a) - \psi(a) + \log b - \log (b + 1) \\
  &amp;= \sum_{i=1}^n \sum_{k=1}^{y_i}{\frac{1}{a+k-1}} + \log b - \log (b + 1) \\
  &amp;= \sum_{i=1}^n \left( \sum_{k=1}^{y_i}{\frac{1}{a+k-1}} + \log b - \log (b + 1) \right) \\
  &amp;= \sum_{i=1}^n \left( \sum_{k=1}^{y_i}{\frac{1}{a+k-1}} \right) + n \log\frac{b}{b+1} \\
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\partial L}{\partial b} 
  &amp;= \frac{\partial}{\partial b} \sum_{i=1}^n \log \Gamma(y_i + a) - \log \Gamma(a) - \log y_i! + a \log b - (y_i + a)\log (b + 1) \\
  &amp;= \sum_{i=1}^n a \frac{1}{b} - (y_i + a) \frac{1}{b + 1} \\
  &amp;= \sum_{i=1}^n \frac{a}{b} - \frac{y_i + a}{b + 1} \\
  &amp;= n \frac{a}{b} - n \frac{a}{b + 1} - \sum_{i=1}^n \frac{y_i}{b + 1} \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(\frac{\partial L}{\partial a} = \frac{\partial L}{\partial b} = 0\)</span> の解が解析的には求まりそうにないので、数値計算法を用いる．</p>
<pre class="r"><code>LL = function (x) {
  a = x[1]
  b = x[2]
  return(
    sum(lgamma(y + a) - lgamma(a) + a * log(b) - (y + a) * log(b + 1))
  )
}
mle = optim(c(0.01, 0.01), LL, control = list(fnscale = -1))
mle</code></pre>
<pre><code>## $par
## [1] 2.231517 1.363840
## 
## $value
## [1] -25.00415
## 
## $counts
## function gradient 
##      119       NA 
## 
## $convergence
## [1] 0
## 
## $message
## NULL</code></pre>
<p>エラーが出ているが収束しているので無視．</p>
<pre class="r"><code>logp = function (theta_1, theta_2, y) {
  a = exp(theta_1)
  b = exp(theta_2)
  return(
    sum(lgamma(y + a) - lgamma(a) + a * log(b) - (y + a) * log(b + 1)) - log(a) - log(b) 
  )
}

n_grid = 2500
theta_1 = seq(0.1, log(mle$par)[1] * 2, length.out = n_grid)
dtheta_1 = diff(theta_1[1:2])
theta_2 = seq(0.1, log(mle$par)[2] * 2, length.out = n_grid)
dtheta_2 = diff(theta_2[1:2])

probs = matrix(nrow = n_grid, ncol = n_grid)
for (i in 1:n_grid) {
  for (j in 1:n_grid) {
    probs[i, j] = logp(theta_1[i], theta_2[j], y)
  }
}
probs = exp(probs)
probs = probs / sum(probs)
marginal_prob = rowSums(probs) # p(theta_1|y)

sample_size = 1000
theta_1_sample = c()
theta_2_sample = c()
for (n in 1:sample_size) {
  i = sample(1:n_grid, 1, replace=TRUE, prob = marginal_prob)
  theta_1_sample = c(theta_1_sample, theta_1[i] + runif(1) * dtheta_1 - dtheta_1 / 2) 
  j = sample(1:n_grid, 1, replace=TRUE, prob = probs[i,]) # p(theta_2|theta_1, y)
  theta_2_sample = c(theta_2_sample, theta_2[j] + runif(1) * dtheta_2 - dtheta_2 / 2)
}
a = exp(theta_1_sample)
b = exp(theta_2_sample)
quantile(a, c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 1.500322 3.035253</code></pre>
<pre class="r"><code>quantile(b, c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 1.121102 1.772769</code></pre>
<p>LearnBayes を用いてみる．</p>
<pre class="r"><code>logp = function (theta, y) {
  a = exp(theta[1])
  b = exp(theta[2])
  return(
    sum(lgamma(y + a) - lgamma(a) + a * log(b) - (y + a) * log(b + 1)) - log(a) - log(b) 
  )
}
s = simcontour(logp, c(0.1, log(mle$par)[1] * 2, 0.1, log(mle$par)[2] * 2), y, 1000)
quantile(exp(s$x), c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 1.448474 3.063377</code></pre>
<pre class="r"><code>quantile(exp(s$y), c(0.05, 0.95))</code></pre>
<pre><code>##       5%      95% 
## 1.116856 1.774916</code></pre>
<p>Stan を用いてみる． その際に、扱いやすい負の二項分布とする<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>．</p>
<p><span class="math display">\[
\begin{aligned}
  p(y|a,b)
  &amp;= \frac{\Gamma(y + a)}{\Gamma(a)y!}\frac{b^a}{(b + 1)^{y+a}} \\
  &amp;= \frac{\Gamma(y + a)}{\Gamma(a)y!} \left( \frac{b}{b + 1} \right)^a \left( \frac{1}{b + 1} \right)^y \\  
  &amp;= \frac{\Gamma(y + a)}{\Gamma(a)y!} \left( \frac{b}{b + 1} \right)^a \left( 1 - \frac{b}{b + 1} \right)^y \\
\end{aligned}
\]</span></p>
<pre class="r"><code>fit</code></pre>
<pre><code>## Inference for Stan model: e625dc1d166f9a9d4fa9c4dcf543c6f8.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##           mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## theta_1   0.18    0.02 0.52  -0.76  -0.19   0.14   0.49   1.27   809    1
## theta_2  -0.37    0.02 0.59  -1.50  -0.75  -0.38   0.00   0.83   846    1
## a         1.39    0.03 0.94   0.47   0.83   1.15   1.64   3.58   814    1
## b         0.83    0.02 0.61   0.22   0.47   0.68   1.00   2.28   818    1
## lp__    -58.23    0.03 1.05 -61.05 -58.66 -57.91 -57.47 -57.19   972    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Jul  1 08:41:20 2020.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<pre class="r"><code>rstan::traceplot(fit, pars = c(&quot;a&quot;, &quot;b&quot;))</code></pre>
<p><img src="chapter4_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<pre class="r"><code>sample = rstan::extract(fit)
quantile(sample$a, c(0.05, 0.95))</code></pre>
<pre><code>##        5%       95% 
## 0.5440772 2.9220998</code></pre>
<pre class="r"><code>quantile(sample$b, c(0.05, 0.95))</code></pre>
<pre><code>##        5%       95% 
## 0.2715782 1.8247837</code></pre>
<p>グリッド近似と同様の尤度関数を用いて実行してみる．</p>
<pre class="r"><code>fit</code></pre>
<pre><code>## Inference for Stan model: 03501badcdaacac034135e387812747c.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##           mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## theta_1   0.23    0.02 0.57  -0.77  -0.16   0.19   0.57   1.46   644 1.00
## theta_2  -0.32    0.02 0.63  -1.52  -0.73  -0.33   0.06   1.00   649 1.00
## a         1.51    0.05 1.21   0.46   0.86   1.21   1.77   4.31   501 1.01
## b         0.90    0.03 0.77   0.22   0.48   0.72   1.07   2.73   496 1.01
## lp__    -26.50    0.04 1.11 -29.53 -26.91 -26.15 -25.72 -25.43   892 1.00
## 
## Samples were drawn using NUTS(diag_e) at Wed Jul  1 08:42:13 2020.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<pre class="r"><code>rstan::traceplot(fit, pars = c(&quot;a&quot;, &quot;b&quot;))</code></pre>
<p><img src="chapter4_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<pre class="r"><code>sample = rstan::extract(fit)
quantile(sample$a, c(0.05, 0.95))</code></pre>
<pre><code>##        5%       95% 
## 0.5323909 3.2379557</code></pre>
<pre class="r"><code>quantile(sample$b, c(0.05, 0.95))</code></pre>
<pre><code>##        5%       95% 
## 0.2758367 2.0449512</code></pre>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://www2.stat.duke.edu/courses/Spring16/sta643/slides/bayes-BF.pdf" class="uri">https://www2.stat.duke.edu/courses/Spring16/sta643/slides/bayes-BF.pdf</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><a href="https://www.cs.ubc.ca/~schmidtm/Courses/540-W18/L20.pdf" class="uri">https://www.cs.ubc.ca/~schmidtm/Courses/540-W18/L20.pdf</a><a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p><a href="https://mc-stan.org/docs/2_23/stan-users-guide/bayesian-measurement-error-model.html" class="uri">https://mc-stan.org/docs/2_23/stan-users-guide/bayesian-measurement-error-model.html</a><a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p><em>Bayesian Data Analysis</em>. Third Edition. (p.76)<a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p><a href="https://ja.wikipedia.org/wiki/ディガンマ関数" class="uri">https://ja.wikipedia.org/wiki/ディガンマ関数</a><a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p><a href="https://mc-stan.org/docs/2_19/functions-reference/negative-binomial-distribution.html" class="uri">https://mc-stan.org/docs/2_19/functions-reference/negative-binomial-distribution.html</a><a href="#fnref6" class="footnote-back">↩</a></p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
